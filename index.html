<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Familia Dibuja">
    <link rel="apple-touch-icon" href="icono.png">
    
    <!-- Android -->
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/png" href="icono.png">
    <link rel="manifest" id="dynamic-manifest">

    <title>FAMILIA DIBUJA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap');

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Fredoka', sans-serif;
            background-color: #334155; 
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        #app { width: 100dvw; height: 100dvh; position: fixed; top: 0; left: 0; }
        
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pl-safe { padding-left: env(safe-area-inset-left); }
        .pr-safe { padding-right: env(safe-area-inset-right); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-bounce-in { animation: bounce-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes bounce-in { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .tool-btn.active { background-color: #e0f2fe; border-color: #3b82f6; color: #2563eb; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .ui-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; }
        .ui-hidden-top { transform: translateY(-120%); opacity: 0; pointer-events: none; }
        .ui-hidden-bottom { transform: translateY(120%); opacity: 0; pointer-events: none; }

        #zoom-container { touch-action: none; transform-origin: 0 0; will-change: transform; }
    </style>
</head>
<body class="bg-slate-800">

    <div id="app" class="relative overflow-hidden">
        
        <!-- LOGIN -->
        <div id="login-view" class="h-full w-full flex flex-col items-center justify-center bg-gradient-to-br from-violet-600 via-fuchsia-500 to-orange-400 p-4 absolute inset-0 z-50">
            <h1 class="text-5xl md:text-7xl font-bold text-white mb-2 text-center drop-shadow-lg tracking-wide select-none">FAMILIA DIBUJA üé®</h1>
            <p class="text-white text-lg mb-8 font-medium opacity-90 tracking-widest uppercase text-center">Estudio de Arte M√°gico</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full max-w-4xl" id="user-grid"></div>
            <p class="absolute bottom-4 text-white/50 text-xs">v4.2 - Carga Flexible</p>
        </div>

        <!-- HOME -->
        <div id="home-view" class="h-full w-full flex-col bg-slate-50 hidden absolute inset-0 z-40 pt-safe pl-safe pr-safe">
            <div class="bg-white px-4 py-3 shadow-md flex justify-between items-center z-10 sticky top-0 rounded-b-xl mx-2 mt-2">
                <div class="flex items-center gap-3">
                    <button onclick="navigate('login')" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 text-slate-600"><i data-lucide="chevron-left" class="w-7 h-7"></i></button>
                    <h2 class="text-xl font-bold leading-none text-slate-700">Hola, <span id="user-name-display" class="text-fuchsia-600 font-black"></span></h2>
                </div>
                <button onclick="navigate('gallery')" class="flex items-center gap-2 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white px-4 py-2 rounded-full font-bold shadow-lg active:scale-95 transition-all">
                    <i data-lucide="image" class="w-5 h-5"></i> <span class="hidden sm:inline">Galer√≠a</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-32">
                <div id="categories-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <button onclick="startDrawing({id:'blank'})" class="category-card bg-white p-4 rounded-3xl shadow-sm border-2 border-slate-100 flex items-center gap-4 hover:border-orange-300 hover:shadow-md group">
                        <div class="w-16 h-16 rounded-2xl bg-orange-100 flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="pencil" class="w-8 h-8 text-orange-500"></i></div>
                        <div class="text-left"><h3 class="font-bold text-lg text-slate-700">Pizarr√≥n Blanco</h3><p class="text-xs text-slate-400">Dibuja lo que quieras</p></div>
                    </button>
                </div>
                <div id="category-detail-view" class="hidden pb-20">
                    <button onclick="showCategories()" class="mb-4 flex items-center gap-2 text-slate-500 font-bold hover:text-slate-700 bg-white px-4 py-2 rounded-full shadow-sm"><i data-lucide="arrow-left" class="w-5 h-5"></i> Volver</button>
                    <h2 id="category-title" class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-3 capitalize"></h2>
                    <div id="templates-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
            </div>
        </div>

        <!-- CANVAS (DIBUJO) -->
        <div id="canvas-view" class="h-full w-full hidden absolute inset-0 z-50 bg-slate-800 overflow-hidden">
            
            <!-- HEADER TOOLS -->
            <div id="canvas-header" class="ui-panel absolute top-0 left-0 right-0 z-30 pt-safe px-4 pointer-events-none">
                <div class="bg-white/95 backdrop-blur-sm shadow-xl rounded-2xl p-2 flex items-center justify-between gap-2 mt-2 pointer-events-auto border border-white/20 mx-auto max-w-4xl">
                    <button onclick="exitCanvas()" class="p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200 active:scale-90 transition-transform shadow-sm">
                        <i data-lucide="x" class="w-6 h-6 stroke-[3px]"></i>
                    </button>
                    
                    <div class="flex gap-1 bg-slate-100 rounded-full p-1 shadow-inner">
                        <button onclick="canvasUndo()" class="p-2 rounded-full hover:bg-slate-200 active:scale-90 text-slate-600"><i data-lucide="undo" class="w-5 h-5"></i></button>
                        <button onclick="canvasRedo()" class="p-2 rounded-full hover:bg-slate-200 active:scale-90 text-slate-600"><i data-lucide="redo" class="w-5 h-5"></i></button>
                    </div>

                    <div class="flex gap-1 bg-slate-100 rounded-full p-1 overflow-x-auto no-scrollbar max-w-[40vw] shadow-inner">
                        <button onclick="setTool('pencil')" id="tool-pencil" class="tool-btn active p-2 rounded-full border border-transparent transition-all"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                        <button onclick="setTool('marker')" id="tool-marker" class="tool-btn p-2 rounded-full border border-transparent transition-all"><i data-lucide="highlighter" class="w-5 h-5"></i></button>
                        <button onclick="setTool('spray')" id="tool-spray" class="tool-btn p-2 rounded-full border border-transparent transition-all"><i data-lucide="spray-can" class="w-5 h-5"></i></button>
                        <button onclick="setTool('rainbow')" id="tool-rainbow" class="tool-btn p-2 rounded-full border border-transparent transition-all text-transparent bg-clip-text bg-gradient-to-r from-red-500 via-green-500 to-blue-500"><i data-lucide="rainbow" class="w-5 h-5 text-purple-500"></i></button>
                        <button onclick="setTool('neon')" id="tool-neon" class="tool-btn p-2 rounded-full border border-transparent transition-all text-fuchsia-500"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                        <button onclick="setTool('eraser')" id="tool-eraser" class="tool-btn p-2 rounded-full border border-transparent transition-all"><i data-lucide="eraser" class="w-5 h-5"></i></button>
                    </div>

                    <button onclick="saveCanvas()" class="bg-green-500 text-white p-2 px-4 rounded-full font-bold shadow-lg active:scale-95 flex items-center gap-2 hover:bg-green-600 transition-colors">
                        <i data-lucide="save" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- AREA DE DIBUJO -->
            <div id="drawing-area" class="w-full h-full flex items-center justify-center touch-none bg-slate-800">
                <div id="zoom-container" class="relative shadow-2xl">
                    <canvas id="drawing-canvas" class="bg-white cursor-crosshair touch-none rounded-sm"></canvas>
                    <div id="template-overlay" class="absolute inset-0 pointer-events-none flex items-center justify-center z-10"></div>
                </div>
            </div>

            <!-- FOOTER TOOLS -->
            <div id="canvas-footer" class="ui-panel absolute bottom-0 left-0 right-0 z-30 pb-safe px-4 pointer-events-none">
                <div class="bg-white/95 backdrop-blur-sm shadow-xl rounded-2xl p-3 flex flex-col gap-3 mb-2 pointer-events-auto border border-white/20 mx-auto max-w-4xl">
                    <div class="flex gap-3 overflow-x-auto pb-1 no-scrollbar px-1 justify-center" id="color-palette"></div>
                    <div class="flex justify-center gap-6 items-center border-t border-slate-100 pt-2">
                        <button onclick="setSize(5)" class="w-4 h-4 rounded-full bg-slate-800 ring-offset-2 hover:ring-2"></button>
                        <button onclick="setSize(12)" class="w-6 h-6 rounded-full bg-slate-800 ring-offset-2 hover:ring-2"></button>
                        <button onclick="setSize(25)" class="w-10 h-10 rounded-full bg-slate-800 ring-offset-2 hover:ring-2"></button>
                        <button onclick="resetZoom()" class="text-xs text-slate-400 font-bold ml-4 bg-slate-100 px-2 py-1 rounded">Reset Zoom</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GALER√çA -->
        <div id="gallery-view" class="h-full w-full flex-col hidden absolute inset-0 z-40 bg-slate-50 pt-safe pl-safe pr-safe">
            <div class="bg-white px-4 py-3 shadow-md flex justify-between items-center z-10 sticky top-0 rounded-b-xl mx-2 mt-2">
                <button onclick="navigate('home')" class="p-2 bg-slate-100 rounded-full text-slate-700"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-slate-800">Galer√≠a</h2>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-32">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-4 rounded-2xl mb-6 shadow-lg text-white">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="clapperboard" class="w-5 h-5"></i> Pel√≠cula</h3>
                        <span id="selection-count" class="text-xs bg-white/20 px-2 py-1 rounded-full">0 selec.</span>
                    </div>
                    <button id="btn-create-video" onclick="createVideo()" disabled class="w-full bg-white text-blue-600 py-2 rounded-lg font-bold shadow-sm disabled:opacity-50 flex justify-center items-center gap-2">¬°Acci√≥n! <i data-lucide="play" class="w-4 h-4 fill-current"></i></button>
                </div>
                <div id="gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 pb-20"></div>
                <div id="empty-gallery" class="hidden text-center text-slate-400 mt-20"><i data-lucide="image" class="w-16 h-16 mx-auto mb-4 opacity-50"></i><p>Galer√≠a vac√≠a.</p></div>
            </div>
        </div>
        
        <!-- VIDEO MODAL -->
        <div id="video-modal" class="fixed inset-0 z-[80] bg-black/95 hidden flex-col items-center justify-center p-4 backdrop-blur-sm">
            <h3 class="text-white text-3xl font-bold mb-6 animate-bounce text-center">¬°Obra Maestra! üé¨</h3>
            <img id="generated-gif" src="" class="max-w-full max-h-[50vh] border-8 border-white rounded-xl shadow-2xl mb-8 bg-white rotate-1">
            <div class="flex flex-col sm:flex-row gap-4 w-full max-w-md">
                 <a id="download-gif-link" href="#" download="mi-pelicula.gif" class="flex-1 bg-green-500 text-white py-4 rounded-2xl font-bold text-lg hover:bg-green-600 text-center flex items-center justify-center gap-2 shadow-lg">Descargar</a>
                <button onclick="closeVideoModal()" class="flex-1 bg-slate-700 text-white py-4 rounded-2xl font-bold text-lg">Cerrar</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURACI√ìN DE IM√ÅGENES ---
    // ¬°AQU√ç ES DONDE REGISTRAS TUS FOTOS!
    
    // OPCI√ìN A: Si renombras tus fotos a "naturaleza_1.png", "naturaleza_2.png", solo pon el n√∫mero.
    // OPCI√ìN B: Si quieres usar nombres propios, pon la lista entre corchetes ['foto1.jpg', 'foto2.png'].
    
    const MIS_IMAGENES = {
        'naturaleza':['naturaleza_1.png', 'naturaleza_2.png', 'naturaleza_3.png', 'naturaleza_4.png', 'naturaleza_5.png'],
        
        'superheroe': 3, // Buscar√° superheroe_1.png ...
        
        // Ejemplo OPCI√ìN B (Descomenta y edita si lo necesitas):
        // 'animales': ['gatito.jpg', 'perro_lindo.png', 'IMG_2023.jpg'],
        
        'princesas': 3,
        'animales': 3,
        'vehiculos': 3,
        'paisajes': 3
    };

    const CAT_META = {
        'naturaleza': { name: 'Naturaleza', icon: 'flower', color: 'bg-lime-100 text-lime-600' },
        'superheroe': { name: 'Superh√©roes', icon: 'shield', color: 'bg-blue-100 text-blue-600' },
        'princesas': { name: 'Princesas', icon: 'crown', color: 'bg-pink-100 text-pink-500' },
        'animales': { name: 'Animales', icon: 'cat', color: 'bg-yellow-100 text-yellow-600' },
        'vehiculos': { name: 'Veh√≠culos', icon: 'car', color: 'bg-green-100 text-green-600' },
        'paisajes': { name: 'Paisajes', icon: 'mountain-snow', color: 'bg-teal-100 text-teal-600' },
        'otros': { name: 'Varios', icon: 'star', color: 'bg-slate-100 text-slate-600' }
    };

    function injectManifest() {
        const manifest = { "name": "Familia Dibuja", "short_name": "Dibujos", "start_url": ".", "display": "standalone", "background_color": "#3b82f6", "theme_color": "#3b82f6", "orientation": "landscape", "icons": [{ "src": "icono.png", "sizes": "192x192", "type": "image/png" }] };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('dynamic-manifest').setAttribute('href', URL.createObjectURL(blob));
    }

    const DB_NAME = 'FamiliaDibujaDBv4';
    const DB_VERSION = 1;
    const USERS = ['ALEXANDER', 'DANIEL', 'ROBERTO', 'BOMBON', 'YERIS'];
    const COLORS = ['#000000', '#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#FF00FF', '#FFFFFF', '#8B4513', '#00FFFF', '#FF1493', '#32CD32', '#F08080', '#20B2AA'];

    let state = { user: null, templates: [], gallery: [], tool: 'pencil', color: '#000000', size: 5, history: [], historyIndex: -1, selectedForVideo: [], drawing: false, currentTemplate: null };
    let zoomState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };

    function generateTemplates() {
        const templates = [];
        for (const [cat, value] of Object.entries(MIS_IMAGENES)) {
            if (typeof value === 'number') {
                // Modo Autom√°tico: busca categoria_1.png
                for (let i = 1; i <= value; i++) {
                    templates.push({ id: `${cat}_${i}`, cat: cat, name: `${cat} ${i}`, file: `${cat}_${i}.png`, type: 'png' });
                }
            } else if (Array.isArray(value)) {
                // Modo Manual: usa la lista de nombres
                value.forEach((filename, idx) => {
                    templates.push({ id: `${cat}_manual_${idx}`, cat: cat, name: `${cat} ${idx+1}`, file: filename, type: 'png' });
                });
            }
        }
        templates.push({ id: 'def_car', cat: 'vehiculos', name: 'Coche Veloz', type: 'svg', content: `<path d="M50 300 H450 V350 H50 Z" /><circle cx="120" cy="350" r="40" /><circle cx="380" cy="350" r="40" /><path d="M100 300 L130 200 H370 L400 300" />` });
        return templates;
    }

    const db = {
        open: () => new Promise((resolve) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains('gallery')) d.createObjectStore('gallery', { keyPath: 'id' });
            };
            req.onsuccess = () => resolve(req.result);
        }),
        getAllGallery: async () => {
             const d = await db.open();
             return new Promise(resolve => {
                 const req = d.transaction('gallery', 'readonly').objectStore('gallery').getAll();
                 req.onsuccess = () => resolve(req.result || []);
             });
        },
        saveGalleryItem: async (item) => {
            const d = await db.open();
            const tx = d.transaction('gallery', 'readwrite');
            tx.objectStore('gallery').put(item);
        },
        deleteGalleryItem: async (id) => {
            const d = await db.open();
            const tx = d.transaction('gallery', 'readwrite');
            tx.objectStore('gallery').delete(id);
        }
    };

    async function init() {
        injectManifest();
        lucide.createIcons();
        renderLogin();
        state.gallery = await db.getAllGallery();
        state.gallery.sort((a,b) => b.id - a.id);
        state.templates = generateTemplates();
        document.getElementById('user-grid').classList.remove('hidden');
        document.getElementById('user-grid').classList.add('grid');
    }

    const dom = {
        views: { login: 'login-view', home: 'home-view', canvas: 'canvas-view', gallery: 'gallery-view' },
        canvas: document.getElementById('drawing-canvas'),
        ctx: document.getElementById('drawing-canvas').getContext('2d'),
        overlay: document.getElementById('template-overlay'),
        zoomContainer: document.getElementById('zoom-container'),
        header: document.getElementById('canvas-header'),
        footer: document.getElementById('canvas-footer')
    };

    function navigate(viewId) {
        Object.values(dom.views).forEach(id => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        });
        document.getElementById(dom.views[viewId]).classList.remove('hidden');
        document.getElementById(dom.views[viewId]).classList.add('flex');
        if (viewId === 'gallery') { state.selectedForVideo = []; renderGallery(); }
        if (viewId === 'home') { renderHomeCategories(); }
        if (viewId === 'canvas') { setTimeout(initCanvasSize, 50); }
    }

    function renderLogin() {
        const grid = document.getElementById('user-grid');
        const colors = ['bg-rose-500', 'bg-blue-500', 'bg-emerald-500', 'bg-purple-500', 'bg-amber-500'];
        grid.innerHTML = USERS.map((u, i) => `
            <button onclick="login('${u}')" class="${colors[i%colors.length]} p-6 rounded-3xl shadow-xl border-4 border-white/30 transform transition hover:scale-105 active:scale-95 animate-bounce-in flex flex-col items-center" style="animation-delay: ${i*100}ms">
                <i data-lucide="smile" class="w-12 h-12 text-white mb-2"></i>
                <span class="text-xl font-black text-white tracking-wider">${u}</span>
            </button>
        `).join('');
        lucide.createIcons();
    }
    function login(name) { state.user = name; document.getElementById('user-name-display').innerText = name; navigate('home'); }

    function renderHomeCategories() {
        const container = document.getElementById('categories-list');
        const staticHtml = container.innerHTML.split('<!-- Las dem√°s')[0];
        const availableCats = new Set(state.templates.map(t => t.cat || 'otros'));
        const dynamicHtml = Array.from(availableCats).map(catKey => {
            const meta = CAT_META[catKey] || CAT_META['otros'];
            return `<button onclick="openCategory('${catKey}')" class="category-card bg-white p-4 rounded-3xl shadow-sm border-2 border-slate-100 flex items-center gap-4 hover:border-blue-300 hover:shadow-md group"><div class="w-16 h-16 rounded-2xl ${meta.color} flex items-center justify-center group-hover:scale-110 transition-transform"><i data-lucide="${meta.icon}" class="w-8 h-8"></i></div><div class="text-left"><h3 class="font-bold text-lg text-slate-700 capitalize">${meta.name}</h3><p class="text-xs text-slate-400">Ver dibujos</p></div></button>`;
        }).join('');
        container.innerHTML = staticHtml + dynamicHtml;
        lucide.createIcons();
    }

    function openCategory(catKey) {
        document.getElementById('categories-list').classList.add('hidden');
        document.getElementById('category-detail-view').classList.remove('hidden');
        document.getElementById('category-title').innerText = CAT_META[catKey]?.name || catKey;
        const templates = state.templates.filter(t => (t.cat || 'otros') === catKey);
        const grid = document.getElementById('templates-grid');
        grid.innerHTML = templates.map(t => {
            let imgContent = t.type === 'svg' ? `<img src="data:image/svg+xml;base64,${btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" stroke="black" stroke-width="8" fill="none">${t.content}</svg>`)}" class="w-full h-full object-contain pointer-events-none select-none">` : `<img src="${t.file}" class="w-full h-full object-contain pointer-events-none select-none" onerror="this.src='';this.parentElement.innerHTML='<span class=\\'text-xs text-red-400\\'>Sin Imagen</span>'">`;
            return `<button onclick='startDrawing(${JSON.stringify(t)})' class="w-full bg-white p-2 rounded-3xl shadow border-2 border-slate-100 hover:border-blue-400 hover:shadow-lg transition-all flex flex-col items-center gap-2 group animate-bounce-in"><div class="w-full aspect-square bg-slate-50 rounded-xl overflow-hidden flex items-center justify-center p-2 relative">${imgContent}</div><span class="font-bold text-slate-600 text-sm truncate w-full text-center capitalize">${t.name}</span></button>`;
        }).join('');
    }
    function showCategories() { document.getElementById('categories-list').classList.remove('hidden'); document.getElementById('category-detail-view').classList.add('hidden'); }

    // --- CANVAS LOGIC & ZOOM ---
    async function startDrawing(template) {
        state.currentTemplate = template;
        state.history = []; state.historyIndex = -1;
        setTool('pencil');
        navigate('canvas');
        dom.overlay.innerHTML = '';
        if (template.id !== 'blank') {
            const img = new Image();
            img.className = "w-full h-full object-contain opacity-90 pointer-events-none select-none";
            img.src = template.type === 'svg' ? 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" width="500" height="500" stroke="black" stroke-width="8" fill="none">${template.content}</svg>`) : template.file;
            dom.overlay.appendChild(img);
        }
        renderPalette();
        setTimeout(() => saveHistory(), 100);
        resetZoom();
    }

    function initCanvasSize() {
        const container = document.getElementById('drawing-area');
        const width = container.clientWidth - 40; 
        const height = container.clientHeight - 40;
        
        dom.canvas.width = width;
        dom.canvas.height = height;
        dom.zoomContainer.style.width = width + 'px';
        dom.zoomContainer.style.height = height + 'px';
        
        dom.ctx.lineCap = 'round'; dom.ctx.lineJoin = 'round';
        if (state.historyIndex === -1) {
            dom.ctx.fillStyle = 'white'; dom.ctx.fillRect(0,0, dom.canvas.width, dom.canvas.height);
        } else if (state.history[state.historyIndex]) {
            restoreImage(state.history[state.historyIndex]);
        }
        updateCtx();
    }

    function resetZoom() {
        zoomState = { scale: 1, panning: false, pointX: 0, pointY: 0, startX: 0, startY: 0 };
        updateZoomTransform();
    }

    function updateZoomTransform() {
        dom.zoomContainer.style.transform = `translate(${zoomState.pointX}px, ${zoomState.pointY}px) scale(${zoomState.scale})`;
    }

    // MULTITOUCH
    const touchHandler = document.getElementById('drawing-area');
    let initialDist = 0; let initialScale = 1;

    touchHandler.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            zoomState.panning = true;
            initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            initialScale = zoomState.scale;
        } else if (e.touches.length === 1 && !zoomState.panning) {
            hideUI();
            state.drawing = true;
            const pos = getPos(e.touches[0]);
            dom.ctx.beginPath();
            dom.ctx.moveTo(pos.x, pos.y);
            if(state.tool === 'spray') { spray(pos); state.sprayInterval = setInterval(()=>spray(getPos(e.touches[0])), 50); }
        }
    }, {passive: false});

    touchHandler.addEventListener('touchmove', e => {
        e.preventDefault();
        if (e.touches.length === 2 && zoomState.panning) {
            const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            zoomState.scale = Math.min(Math.max(0.5, initialScale * (dist / initialDist)), 4);
            updateZoomTransform();
        } else if (e.touches.length === 1 && state.drawing) {
            const pos = getPos(e.touches[0]);
            if(state.tool === 'spray') return;
            if (state.tool === 'rainbow') {
                dom.ctx.strokeStyle = `hsl(${(Date.now()/10)%360}, 100%, 50%)`;
                dom.ctx.beginPath(); dom.ctx.moveTo(state.lastX || pos.x, state.lastY || pos.y);
            }
            dom.ctx.lineTo(pos.x, pos.y);
            dom.ctx.stroke();
            state.lastX = pos.x; state.lastY = pos.y;
        }
    }, {passive: false});

    touchHandler.addEventListener('touchend', e => {
        if (state.drawing) {
            state.drawing = false; clearInterval(state.sprayInterval); dom.ctx.closePath(); saveHistory();
            showUI();
            state.lastX = null; state.lastY = null;
        }
        if (e.touches.length < 2) zoomState.panning = false;
    });

    // MOUSE FALLBACK
    dom.canvas.addEventListener('mousedown', e => { hideUI(); state.drawing = true; const pos = getPos(e); dom.ctx.beginPath(); dom.ctx.moveTo(pos.x, pos.y); });
    window.addEventListener('mousemove', e => {
        if (!state.drawing) return;
        const pos = getPos(e);
        if(state.tool === 'rainbow') { dom.ctx.strokeStyle = `hsl(${(Date.now()/10)%360}, 100%, 50%)`; dom.ctx.beginPath(); dom.ctx.moveTo(state.lastX || pos.x, state.lastY || pos.y); }
        dom.ctx.lineTo(pos.x, pos.y); dom.ctx.stroke(); state.lastX = pos.x; state.lastY = pos.y;
    });
    window.addEventListener('mouseup', () => { if(state.drawing) { state.drawing = false; dom.ctx.closePath(); saveHistory(); showUI(); state.lastX=null;} });

    function getPos(e) {
        const rect = dom.canvas.getBoundingClientRect();
        const scaleX = dom.canvas.width / rect.width;
        const scaleY = dom.canvas.height / rect.height;
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
    }

    // UI
    function hideUI() { dom.header.classList.add('ui-hidden-top'); dom.footer.classList.add('ui-hidden-bottom'); }
    function showUI() { dom.header.classList.remove('ui-hidden-top'); dom.footer.classList.remove('ui-hidden-bottom'); }
    function setTool(toolName) { state.tool = toolName; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tool-${toolName}`).classList.add('active'); updateCtx(); }
    function setSize(s) { state.size = s; updateCtx(); }
    function setColor(c) { state.color = c; if(state.tool === 'eraser') setTool('pencil'); renderPalette(); updateCtx(); }
    function updateCtx() {
        const ctx = dom.ctx; ctx.lineWidth = state.size; ctx.shadowBlur = 0; ctx.globalAlpha = 1;
        if (state.tool === 'eraser') ctx.strokeStyle = '#FFFFFF';
        else if (state.tool === 'marker') { ctx.strokeStyle = state.color; ctx.globalAlpha = 0.5; }
        else if (state.tool === 'neon') { ctx.strokeStyle = state.color; ctx.shadowBlur = 10; ctx.shadowColor = state.color; }
        else ctx.strokeStyle = state.color;
    }
    function renderPalette() { document.getElementById('color-palette').innerHTML = COLORS.map(c => `<button onclick="setColor('${c}')" class="flex-shrink-0 w-8 h-8 rounded-full border-2 border-white shadow-sm transition-transform ${state.color === c ? 'scale-110 ring-2 ring-blue-400' : ''}" style="background-color: ${c}"></button>`).join(''); }
    function spray(pos) { dom.ctx.fillStyle = state.color; for(let i=0;i<10;i++) { const o=state.size*2; dom.ctx.fillRect(pos.x+(Math.random()*o-o/2), pos.y+(Math.random()*o-o/2), 1, 1); } }
    
    // GUARDADO
    async function saveCanvas() {
        const tempCanvas = document.createElement('canvas'); tempCanvas.width = dom.canvas.width; tempCanvas.height = dom.canvas.height; const tCtx = tempCanvas.getContext('2d');
        tCtx.drawImage(dom.canvas, 0, 0);
        if (state.currentTemplate && state.currentTemplate.id !== 'blank') {
            const overlayImg = dom.overlay.querySelector('img');
            if (overlayImg) {
                const i = new Image(); i.src = overlayImg.src; await new Promise(r => i.onload = r);
                const s = 1; const ai = i.naturalWidth/i.naturalHeight; const ac = tempCanvas.width/tempCanvas.height;
                let w,h; if(ai>ac){w=tempCanvas.width*s;h=w/ai}else{h=tempCanvas.height*s;w=h*ai}
                tCtx.drawImage(i, (tempCanvas.width-w)/2, (tempCanvas.height-h)/2, w, h);
            }
        }
        const dataUrl = tempCanvas.toDataURL();
        await db.saveGalleryItem({ id: Date.now(), user: state.user, image: dataUrl });
        alert('¬°Guardado!'); state.gallery.unshift({id: Date.now(), user: state.user, image: dataUrl}); navigate('home');
    }

    // UTILIDADES & CONTROL
    function canvasUndo() { if (state.historyIndex > 0) { state.historyIndex--; restoreImage(state.history[state.historyIndex]); } }
    function canvasRedo() { if (state.historyIndex < state.history.length - 1) { state.historyIndex++; restoreImage(state.history[state.historyIndex]); } }
    function restoreImage(url) { const i = new Image(); i.src = url; i.onload = () => { dom.ctx.clearRect(0,0,dom.canvas.width,dom.canvas.height); dom.ctx.globalAlpha=1; dom.ctx.shadowBlur=0; dom.ctx.drawImage(i,0,0); updateCtx(); }; }
    function saveHistory() { if (state.historyIndex < state.history.length - 1) state.history = state.history.slice(0, state.historyIndex + 1); state.history.push(dom.canvas.toDataURL()); state.historyIndex++; }
    function renderGallery() { 
        const g = document.getElementById('gallery-grid'); g.innerHTML = state.gallery.length ? state.gallery.map(i => `<div onclick="toggleSelectVideo(${i.id})" class="relative rounded-xl overflow-hidden shadow-md aspect-square bg-white border-2 transition-all ${state.selectedForVideo.includes(i.id)?'border-blue-500 ring-4':''}"><img src="${i.image}" class="w-full h-full object-cover"><div class="absolute bottom-0 w-full bg-white/90 p-1 flex justify-between"><span class="text-[10px] font-bold uppercase">${i.user}</span><button onclick="deleteImg(event,${i.id})" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('') : ''; 
        document.getElementById('empty-gallery').classList.toggle('hidden', state.gallery.length > 0);
        lucide.createIcons();
    }
    function toggleSelectVideo(id) { if(state.selectedForVideo.includes(id)) state.selectedForVideo=state.selectedForVideo.filter(i=>i!==id); else state.selectedForVideo.push(id); document.getElementById('selection-count').innerText=`${state.selectedForVideo.length}`; document.getElementById('btn-create-video').disabled=state.selectedForVideo.length<2; renderGallery(); }
    async function deleteImg(e,id) { e.stopPropagation(); if(confirm('¬øBorrar?')) { await db.deleteGalleryItem(id); state.gallery=state.gallery.filter(i=>i.id!==id); renderGallery(); } }
    function createVideo() { 
        const btn=document.getElementById('btn-create-video'); btn.disabled=true; btn.innerHTML='Creando...';
        const imgs = state.gallery.filter(i=>state.selectedForVideo.includes(i.id)).sort((a,b)=>a.id-b.id).map(i=>i.image);
        gifshot.createGIF({images:imgs, interval:0.5, gifWidth:400, gifHeight:400}, o => { 
            if(!o.error) { document.getElementById('generated-gif').src=o.image; document.getElementById('download-gif-link').href=o.image; document.getElementById('video-modal').classList.remove('hidden'); document.getElementById('video-modal').classList.add('flex'); }
            btn.innerHTML='¬°Acci√≥n!'; btn.disabled=false;
        });
    }
    function closeVideoModal() { document.getElementById('video-modal').classList.add('hidden'); document.getElementById('video-modal').classList.remove('flex'); }
    
    // FUNCI√ìN DE SALIDA
    function exitCanvas() {
        navigate('home');
    }
    
    init();
</script>
</body>
</html>
